"use strict";
(self["webpackChunkwebpack_demo"] = self["webpackChunkwebpack_demo"] || []).push([["index"],{

/***/ "./node_modules/css-loader/dist/cjs.js!./src/style.css":
/*!*************************************************************!*\
  !*** ./node_modules/css-loader/dist/cjs.js!./src/style.css ***!
  \*************************************************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/* harmony import */ var _node_modules_css_loader_dist_runtime_cssWithMappingToString_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../node_modules/css-loader/dist/runtime/cssWithMappingToString.js */ "./node_modules/css-loader/dist/runtime/cssWithMappingToString.js");
/* harmony import */ var _node_modules_css_loader_dist_runtime_cssWithMappingToString_js__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_node_modules_css_loader_dist_runtime_cssWithMappingToString_js__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../node_modules/css-loader/dist/runtime/api.js */ "./node_modules/css-loader/dist/runtime/api.js");
/* harmony import */ var _node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__);
// Imports


var ___CSS_LOADER_EXPORT___ = _node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1___default()((_node_modules_css_loader_dist_runtime_cssWithMappingToString_js__WEBPACK_IMPORTED_MODULE_0___default()));
// Module
___CSS_LOADER_EXPORT___.push([module.id, "html,\nbody {\n  margin: 0;\n  padding: 0;\n  height: 100%;\n  overflow: hidden;\n}\ncanvas {\n  width: 100%;\n  height: 100%;\n}\n", "",{"version":3,"sources":["webpack://./src/style.css"],"names":[],"mappings":"AAAA;;EAEE,SAAS;EACT,UAAU;EACV,YAAY;EACZ,gBAAgB;AAClB;AACA;EACE,WAAW;EACX,YAAY;AACd","sourcesContent":["html,\nbody {\n  margin: 0;\n  padding: 0;\n  height: 100%;\n  overflow: hidden;\n}\ncanvas {\n  width: 100%;\n  height: 100%;\n}\n"],"sourceRoot":""}]);
// Exports
/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (___CSS_LOADER_EXPORT___);


/***/ }),

/***/ "./src/RobotExpressive.glb":
/*!*********************************!*\
  !*** ./src/RobotExpressive.glb ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (__webpack_require__.p + "06f9d5cfb2ed5af3e12029c43ab7a704.glb");

/***/ }),

/***/ "./src/style.css":
/*!***********************!*\
  !*** ./src/style.css ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/* harmony import */ var _node_modules_style_loader_dist_runtime_injectStylesIntoStyleTag_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! !../node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js */ "./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js");
/* harmony import */ var _node_modules_style_loader_dist_runtime_injectStylesIntoStyleTag_js__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_node_modules_style_loader_dist_runtime_injectStylesIntoStyleTag_js__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _node_modules_style_loader_dist_runtime_styleDomAPI_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! !../node_modules/style-loader/dist/runtime/styleDomAPI.js */ "./node_modules/style-loader/dist/runtime/styleDomAPI.js");
/* harmony import */ var _node_modules_style_loader_dist_runtime_styleDomAPI_js__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(_node_modules_style_loader_dist_runtime_styleDomAPI_js__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var _node_modules_style_loader_dist_runtime_insertBySelector_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! !../node_modules/style-loader/dist/runtime/insertBySelector.js */ "./node_modules/style-loader/dist/runtime/insertBySelector.js");
/* harmony import */ var _node_modules_style_loader_dist_runtime_insertBySelector_js__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(_node_modules_style_loader_dist_runtime_insertBySelector_js__WEBPACK_IMPORTED_MODULE_2__);
/* harmony import */ var _node_modules_style_loader_dist_runtime_setAttributesWithoutAttributes_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! !../node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js */ "./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js");
/* harmony import */ var _node_modules_style_loader_dist_runtime_setAttributesWithoutAttributes_js__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(_node_modules_style_loader_dist_runtime_setAttributesWithoutAttributes_js__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var _node_modules_style_loader_dist_runtime_insertStyleElement_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! !../node_modules/style-loader/dist/runtime/insertStyleElement.js */ "./node_modules/style-loader/dist/runtime/insertStyleElement.js");
/* harmony import */ var _node_modules_style_loader_dist_runtime_insertStyleElement_js__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(_node_modules_style_loader_dist_runtime_insertStyleElement_js__WEBPACK_IMPORTED_MODULE_4__);
/* harmony import */ var _node_modules_style_loader_dist_runtime_styleTagTransform_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! !../node_modules/style-loader/dist/runtime/styleTagTransform.js */ "./node_modules/style-loader/dist/runtime/styleTagTransform.js");
/* harmony import */ var _node_modules_style_loader_dist_runtime_styleTagTransform_js__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(_node_modules_style_loader_dist_runtime_styleTagTransform_js__WEBPACK_IMPORTED_MODULE_5__);
/* harmony import */ var _node_modules_css_loader_dist_cjs_js_style_css__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! !!../node_modules/css-loader/dist/cjs.js!./style.css */ "./node_modules/css-loader/dist/cjs.js!./src/style.css");

      
      
      
      
      
      
      
      
      

var options = {};

options.styleTagTransform = (_node_modules_style_loader_dist_runtime_styleTagTransform_js__WEBPACK_IMPORTED_MODULE_5___default());
options.setAttributes = (_node_modules_style_loader_dist_runtime_setAttributesWithoutAttributes_js__WEBPACK_IMPORTED_MODULE_3___default());

      options.insert = _node_modules_style_loader_dist_runtime_insertBySelector_js__WEBPACK_IMPORTED_MODULE_2___default().bind(null, "head");
    
options.domAPI = (_node_modules_style_loader_dist_runtime_styleDomAPI_js__WEBPACK_IMPORTED_MODULE_1___default());
options.insertStyleElement = (_node_modules_style_loader_dist_runtime_insertStyleElement_js__WEBPACK_IMPORTED_MODULE_4___default());

var update = _node_modules_style_loader_dist_runtime_injectStylesIntoStyleTag_js__WEBPACK_IMPORTED_MODULE_0___default()(_node_modules_css_loader_dist_cjs_js_style_css__WEBPACK_IMPORTED_MODULE_6__.default, options);




       /* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (_node_modules_css_loader_dist_cjs_js_style_css__WEBPACK_IMPORTED_MODULE_6__.default && _node_modules_css_loader_dist_cjs_js_style_css__WEBPACK_IMPORTED_MODULE_6__.default.locals ? _node_modules_css_loader_dist_cjs_js_style_css__WEBPACK_IMPORTED_MODULE_6__.default.locals : undefined);


/***/ }),

/***/ "./src/components/direction.js":
/*!*************************************!*\
  !*** ./src/components/direction.js ***!
  \*************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (/* binding */ Direction)
/* harmony export */ });
function Direction() {
  let lastKey = null,
    lastUpTime = 0;
  let direction = {
    left: false,
    front: false,
    back: false,
    right: false,
    shift: false,
    doubleKey: '',
    value() {
      if (this.left && this.front) return 'LeftFront';
      if (this.left && this.back) return 'LeftBack';
      if (this.right && this.front) return 'RightFront';
      if (this.right && this.back) return 'RightBack';
      if (this.left) return 'Left';
      if (this.front) return 'Front';
      if (this.back) return 'Back';
      if (this.right) return 'Right';
      return false;
    },
  };

  document.addEventListener('keydown', function (ev) {
    if (lastKey === ev.code && new Date().getTime() - lastUpTime < 300) {
      direction.doubleKey = ev.code;
    }
    switch (ev.code) {
      case 'KeyA':
        direction.left = true;
        break;
      case 'KeyW':
        direction.front = true;
        break;
      case 'KeyD':
        direction.right = true;
        break;
      case 'KeyS':
        direction.back = true;
        break;
      case 'ShiftLeft':
        direction.shift = true;
        break;
    }
  });

  document.addEventListener('keyup', function (ev) {
    if (direction.doubleKey === ev.code) direction.doubleKey = '';
    lastKey = ev.code;
    lastUpTime = new Date().getTime();
    switch (ev.code) {
      case 'KeyA':
        direction.left = false;
        break;
      case 'KeyW':
        direction.front = false;
        break;
      case 'KeyD':
        direction.right = false;
        break;
      case 'KeyS':
        direction.back = false;
        break;
      case 'ShiftLeft':
        direction.shift = false;
        break;
    }
    return false;
  });

  return direction;
}


/***/ }),

/***/ "./src/index.js":
/*!**********************!*\
  !*** ./src/index.js ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony import */ var lodash__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! lodash */ "./node_modules/lodash/lodash.js");
/* harmony import */ var lodash__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(lodash__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var three__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! three */ "./node_modules/three/build/three.module.js");
/* harmony import */ var _style_css__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./style.css */ "./src/style.css");
/* harmony import */ var three_examples_jsm_controls_OrbitControls_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! three/examples/jsm/controls/OrbitControls.js */ "./node_modules/three/examples/jsm/controls/OrbitControls.js");
/* harmony import */ var three_examples_jsm_controls_PointerLockControls_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! three/examples/jsm/controls/PointerLockControls.js */ "./node_modules/three/examples/jsm/controls/PointerLockControls.js");
/* harmony import */ var dat_gui__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! dat.gui */ "./node_modules/dat.gui/build/dat.gui.module.js");
/* harmony import */ var three_examples_jsm_libs_stats_module_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! three/examples/jsm/libs/stats.module.js */ "./node_modules/three/examples/jsm/libs/stats.module.js");
/* harmony import */ var _RobotExpressive_glb__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./RobotExpressive.glb */ "./src/RobotExpressive.glb");
/* harmony import */ var three_examples_jsm_loaders_GLTFLoader_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! three/examples/jsm/loaders/GLTFLoader.js */ "./node_modules/three/examples/jsm/loaders/GLTFLoader.js");
/* harmony import */ var _components_direction__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./components/direction */ "./src/components/direction.js");
/* harmony import */ var _img_case_jpg__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./img/case.jpg */ "./src/img/case.jpg");
/* harmony import */ var _img_sand_jpg__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./img/sand.jpg */ "./src/img/sand.jpg");













function main() {
  const textureLoader = new three__WEBPACK_IMPORTED_MODULE_11__.TextureLoader(); //图片渲染器
  const obstacle = []; //障碍物列表
  let direction = (0,_components_direction__WEBPACK_IMPORTED_MODULE_8__.default)(); //方向
  let container, //div容器
    controls, //div容器
    stats, //fps指示器
    clock, //时钟
    mixer, //动画混合器
    actions, //行为
    activeAction, //活动中行为
    previousAction; //上一个行为
  let camera, //相机
    scene, // 场景
    renderer, // 渲染器
    model, // 机器人模块
    face; // 面部表情
  let time = null, // 行走状态防抖
    walk = false, // 是否是行走状态
    jump = false, // 是否跳跃状态
    re_jump = true, // 是否跳跃状态
    reset_jump_height = false, // 重置跳跃高度
    deathing = false, // 即将死亡
    groundPlane = 0; // 地面高度

  const directionObj = {
    Left: -Math.PI / 2,
    LeftBack: -Math.PI / 4,
    Back: 0,
    RightBack: Math.PI / 4,
    Right: Math.PI / 2,
    RightFront: (Math.PI * 3) / 4,
    Front: Math.PI,
    LeftFront: -Math.PI / 2,
  };
  const api = { state: 'Walking' };
  let RobotPositon = { x: 0, y: 0, z: 0 };

  let faceTo = 'Back';

  let num = 0;
  let new_height = 0;
  let falling = false;
  let fall_time = 0;
  let fall_height = 0;

  init();
  animate();

  function init() {
    //创建div
    container = document.createElement('div');
    document.body.appendChild(container);

    //创建相机
    camera = new three__WEBPACK_IMPORTED_MODULE_11__.PerspectiveCamera(
      45,
      window.innerWidth / window.innerHeight,
      0.25,
      1000
    );
    camera.position.set(0, 100, 150);
    camera.lookAt(new three__WEBPACK_IMPORTED_MODULE_11__.Vector3(0, 0, 0));

    //创建场景
    scene = new three__WEBPACK_IMPORTED_MODULE_11__.Scene();
    scene.background = new three__WEBPACK_IMPORTED_MODULE_11__.Color(0xe0e0e0);
    //创建雾
    scene.fog = new three__WEBPACK_IMPORTED_MODULE_11__.Fog(0xe0e0e0, 20, 500);
    //时间
    clock = new three__WEBPACK_IMPORTED_MODULE_11__.Clock();

    //天空地面光
    const hemiLight = new three__WEBPACK_IMPORTED_MODULE_11__.HemisphereLight(0xffffff, 0x444444);
    hemiLight.position.set(0, 20, 0);
    scene.add(hemiLight);

    //方向光
    const dirLight = new three__WEBPACK_IMPORTED_MODULE_11__.DirectionalLight(0xffffff);
    dirLight.position.set(0, 20, 10);
    scene.add(dirLight);

    // ground

    const mesh = new three__WEBPACK_IMPORTED_MODULE_11__.Mesh(
      new three__WEBPACK_IMPORTED_MODULE_11__.PlaneGeometry(2000, 2000),
      //depthWrite 是否渲染看不到的地方
      new three__WEBPACK_IMPORTED_MODULE_11__.MeshPhongMaterial({ color: 0x999999, depthWrite: false })
    );
    mesh.rotation.x = -Math.PI / 2;
    scene.add(mesh);

    //地面辅助线
    const grid = new three__WEBPACK_IMPORTED_MODULE_11__.GridHelper(1000, 200, 0x000000, 0x000000);
    grid.material.opacity = 0.2;
    grid.material.transparent = true;
    scene.add(grid);

    const box_material = new three__WEBPACK_IMPORTED_MODULE_11__.MeshLambertMaterial({
      map: textureLoader.load(_img_case_jpg__WEBPACK_IMPORTED_MODULE_9__),
    });

    const blue_material = new three__WEBPACK_IMPORTED_MODULE_11__.MeshLambertMaterial({ color: 0x1890ff });
    const grey_material = new three__WEBPACK_IMPORTED_MODULE_11__.MeshLambertMaterial({ color: 0xd9d9d9 });

    //泳池
    newBox(4, 4, 4, box_material, -7, 2, -15);
    newBox(10, 10, 10, box_material, -13, 5, -15);
    newBox(30, 1, 8, box_material, -30, 8, -15);
    newBox(100, 1, 100, blue_material, -60, 0.5, -15);
    newBox(102, 1, 102, grey_material, -60, 0.4, -15);

    // 木箱阵
    newBox(4, 4, 4, box_material, 7, 2, -15); // 1
    newBox(10, 10, 10, box_material, 15, 5, -15); // 2
    newBox(10, 10, 10, box_material, 30, 5, -15); // 3
    newBox(10, 10, 10, box_material, 30, 5, -30); // 4
    newBox(10, 10, 10, box_material, 30, 5, -45); // 5
    newBox(10, 10, 10, box_material, 48, 5, -45); // 6
    newBox(10, 10, 10, box_material, 66, 5, -45); // 7
    newBox(10, 10, 10, box_material, 66, 5, -25); // 8
    newBox(10, 10, 10, box_material, 66, 5, -5); // 9
    newBox(10, 10, 10, box_material, 46, 5, 15); // 10

    function newBox(width, height, length, material, x, y, z) {
      const box = new three__WEBPACK_IMPORTED_MODULE_11__.Mesh(
        new three__WEBPACK_IMPORTED_MODULE_11__.BoxGeometry(width, height, length),
        material
      );
      box.position.set(x, y, z);
      scene.add(box);
      obstacle.push(box);
    }

    //添加一个锥体
    // const cone = new THREE.Mesh(
    //   new THREE.ConeGeometry(8, 15, 50),
    //   new THREE.MeshLambertMaterial({ map: textureLoader.load(sandImg) })
    // );
    // cone.rotation.set(0, Math.PI / 2, 0);
    // cone.position.set(15, 7, 0);
    // scene.add(cone);
    // obstacle.push(cone);

    // model

    const loader = new three_examples_jsm_loaders_GLTFLoader_js__WEBPACK_IMPORTED_MODULE_7__.GLTFLoader();

    loader.load(
      _RobotExpressive_glb__WEBPACK_IMPORTED_MODULE_6__.default,
      function (gltf) {
        model = gltf.scene;
        scene.add(model);
        console.log(model);

        actionInit(model, gltf.animations);
      },
      undefined,
      function (e) {
        console.error(e);
      }
    );

    renderer = new three__WEBPACK_IMPORTED_MODULE_11__.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = three__WEBPACK_IMPORTED_MODULE_11__.sRGBEncoding;
    container.appendChild(renderer.domElement);

    //控制器
    controls = new three_examples_jsm_controls_OrbitControls_js__WEBPACK_IMPORTED_MODULE_2__.OrbitControls(camera, renderer.domElement);

    window.addEventListener('resize', onWindowResize);
    stats = new three_examples_jsm_libs_stats_module_js__WEBPACK_IMPORTED_MODULE_5__.default();
    container.appendChild(stats.dom);
  }

  function actionInit(model, animations) {
    const states = [
      'Idle',
      'Walking',
      'Running',
      'Dance',
      'Death',
      'Sitting',
      'Standing',
    ];
    const emotes = [
      'Jump',
      'Yes',
      'No',
      'Wave',
      'Punch',
      'ThumbsUp',
      'WalkJump',
    ];

    //注册动画行为
    mixer = new three__WEBPACK_IMPORTED_MODULE_11__.AnimationMixer(model);

    actions = {};
    for (let i = 0; i < animations.length; i++) {
      const clip = animations[i];
      const action = mixer.clipAction(clip);
      actions[clip.name] = action;

      if (emotes.indexOf(clip.name) >= 0 || states.indexOf(clip.name) >= 4) {
        action.clampWhenFinished = true;
        action.loop = three__WEBPACK_IMPORTED_MODULE_11__.LoopOnce;
      }
    }
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function changeDirection(code) {
    model.rotation.y = directionObj[code];
  }

  function fadeToAction(name, duration) {
    previousAction = activeAction;
    activeAction = actions[name];
    if (previousAction && previousAction !== activeAction) {
      previousAction.fadeOut(duration);
    }

    activeAction
      .reset()
      .setEffectiveTimeScale(1)
      .setEffectiveWeight(1)
      .fadeIn(duration)
      .play();
  }
  let keyAction = {
    Digit1: 'Dance',
    Digit2: 'No',
    Digit3: 'Punch',
    Digit4: 'Sitting',
    Digit5: 'Standing',
    Digit6: 'ThumbsUp',
    Digit7: 'WalkJump',
    Digit8: 'Wave',
    Digit9: 'Yes',
  };
  let shift_down = false;
  document.addEventListener('keydown', function (e) {
    if (e.code === 'Space' && re_jump) {
      action(walk && shift_down ? 'WalkJump' : 'Jump');
      if (jump === true) reset_jump_height = true;
      jump = true;
      new_height = RobotPositon.y;
      re_jump = false;
    }
    if (keyAction[e.code]) {
      action(keyAction[e.code]);
    }
  });
  document.addEventListener('keyup', function (e) {
    if (e.code === 'Space') {
      // re_jump = true;
    }
  });
  function isWalk(direction) {
    const walking = direction.value();
    if (!walking) return false;
    time && clearTimeout(time);
    if (!walk || shift_down !== direction.shift) {
      shift_down = direction.shift;
      fadeToAction(shift_down ? 'Running' : 'Walking', 0.2);
    }
    time = setTimeout(
      () => {
        walk = false;
        fadeToAction('Idle', 0.2);
      },
      walk ? 100 : 600
    );
    walk = true;
  }

  function action(name, time = 0.2) {
    fadeToAction(name, time);
    // 执行结束恢复状态
    mixer.addEventListener('finished', restoreState);
  }

  function restoreState() {
    mixer.removeEventListener('finished', restoreState);

    fadeToAction(walk ? (shift_down ? 'Running' : 'Walking') : 'Idle', 0.2);
  }

  function getDirection(dire) {
    if (!dire) return;
    if (faceTo !== dire) {
      changeDirection(dire);
    }
    faceTo = dire;
  }
  function getPosition(dire) {
    let length = dire.shift ? 0.2 : 0.1;
    let x = RobotPositon.x,
      height = RobotPositon.y,
      z = RobotPositon.z;
    if (direction.left) x -= length;
    if (direction.front) z -= length;
    if (direction.back) z += length;
    if (direction.right) x += length;
    if (jump) {
      num += 0.1;
      if (reset_jump_height) {
        new_height = RobotPositon.y;
        reset_jump_height = false;
        num = 0;
        if (new_height > 50) {
          deathing = true;
        }
      }
      let y = (new_height + 8 - 2 * Math.pow(num - 2, 2)).toFixed(2);
      if (y > 0) {
        height = Number(y);
      } else {
        height = 0;
        jump = false;
        num = 0;
        new_height = 0;
        if (deathing) {
          deathing = false;
          fadeToAction('Death', 0.2);
        }
      }
    }

    if (noCollisionCheck(obstacle, x, height, z)) return;

    if (height > 0 && !jump) {
      if (!noCollisionCheck(obstacle, x, height - 1, z)) {
        if (!falling) {
          falling = true;
          fall_time = 0;
          fall_height = RobotPositon.y;
        }
        fall_time += 0.1;
        let end_height = fall_height - Math.pow(fall_time, 2);
        if (end_height > 0) {
          height = end_height;
        } else {
          height = 0;
          falling = false;
        }
      } else {
        re_jump = true;
      }
    }

    if (height === 0) {
      re_jump = true;
    }

    RobotPositon.x = x;
    RobotPositon.y = height;
    RobotPositon.z = z;
  }

  function noCollisionCheck(obstacle, x, height, z) {
    return obstacle.some((a) => {
      if (a.geometry.type === 'BoxGeometry') {
        // 箱子
        let geo = a.geometry;
        return (
          x - 2 < a.position.x + geo.parameters.width / 2 &&
          x + 2 > a.position.x - geo.parameters.width / 2 &&
          height < a.position.y + geo.parameters.height / 2 &&
          height + 2 > a.position.y - geo.parameters.height / 2 &&
          z - 2 < a.position.z + geo.parameters.depth / 2 &&
          z + 2 > a.position.z - geo.parameters.depth / 2
        );
      }
      if (a.geometry.type === 'ConeGeometry') {
        // 锥形
        let geo = a.geometry;
        return (
          x - 2 < a.position.x + geo.parameters.radius &&
          x + 2 > a.position.x - geo.parameters.radius &&
          height < a.position.y + geo.parameters.height / 2 &&
          height + 2 > a.position.y - geo.parameters.height / 2 &&
          z - 2 < a.position.z + geo.parameters.radius &&
          z + 2 > a.position.z - geo.parameters.radius
        );
      }
    });
  }

  function animate() {
    let dire = direction.value();
    getDirection(dire);
    isWalk(direction);
    getPosition(direction);
    model && model.position.set(RobotPositon.x, RobotPositon.y, RobotPositon.z);
    const dt = clock.getDelta();

    if (mixer) mixer.update(dt);

    requestAnimationFrame(animate);

    renderer.render(scene, camera);
    controls.update();
    stats.update();
  }
}

main();


/***/ }),

/***/ "./src/img/case.jpg":
/*!**************************!*\
  !*** ./src/img/case.jpg ***!
  \**************************/
/***/ ((module, __unused_webpack_exports, __webpack_require__) => {

module.exports = __webpack_require__.p + "0dbc7aad2ae4c483190b.jpg";

/***/ }),

/***/ "./src/img/sand.jpg":
/*!**************************!*\
  !*** ./src/img/sand.jpg ***!
  \**************************/
/***/ ((module, __unused_webpack_exports, __webpack_require__) => {

module.exports = __webpack_require__.p + "ff95106bd3ebee210d86.jpg";

/***/ })

},
/******/ __webpack_require__ => { // webpackRuntimeModules
/******/ var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
/******/ __webpack_require__.O(0, ["vendors"], () => (__webpack_exec__("./src/index.js")));
/******/ var __webpack_exports__ = __webpack_require__.O();
/******/ }
]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QTtBQUNBLHNCQUFzQiw0Q0FBYztBQUNwQztBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1I7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly93ZWJwYWNrLWRlbW8vLi9zcmMvc3R5bGUuY3NzIiwid2VicGFjazovL3dlYnBhY2stZGVtby8uL3NyYy9Sb2JvdEV4cHJlc3NpdmUuZ2xiIiwid2VicGFjazovL3dlYnBhY2stZGVtby8uL3NyYy9zdHlsZS5jc3M/NzE2MyIsIndlYnBhY2s6Ly93ZWJwYWNrLWRlbW8vLi9zcmMvY29tcG9uZW50cy9kaXJlY3Rpb24uanMiLCJ3ZWJwYWNrOi8vd2VicGFjay1kZW1vLy4vc3JjL2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIEltcG9ydHNcbmltcG9ydCBfX19DU1NfTE9BREVSX0FQSV9TT1VSQ0VNQVBfSU1QT1JUX19fIGZyb20gXCIuLi9ub2RlX21vZHVsZXMvY3NzLWxvYWRlci9kaXN0L3J1bnRpbWUvY3NzV2l0aE1hcHBpbmdUb1N0cmluZy5qc1wiO1xuaW1wb3J0IF9fX0NTU19MT0FERVJfQVBJX0lNUE9SVF9fXyBmcm9tIFwiLi4vbm9kZV9tb2R1bGVzL2Nzcy1sb2FkZXIvZGlzdC9ydW50aW1lL2FwaS5qc1wiO1xudmFyIF9fX0NTU19MT0FERVJfRVhQT1JUX19fID0gX19fQ1NTX0xPQURFUl9BUElfSU1QT1JUX19fKF9fX0NTU19MT0FERVJfQVBJX1NPVVJDRU1BUF9JTVBPUlRfX18pO1xuLy8gTW9kdWxlXG5fX19DU1NfTE9BREVSX0VYUE9SVF9fXy5wdXNoKFttb2R1bGUuaWQsIFwiaHRtbCxcXG5ib2R5IHtcXG4gIG1hcmdpbjogMDtcXG4gIHBhZGRpbmc6IDA7XFxuICBoZWlnaHQ6IDEwMCU7XFxuICBvdmVyZmxvdzogaGlkZGVuO1xcbn1cXG5jYW52YXMge1xcbiAgd2lkdGg6IDEwMCU7XFxuICBoZWlnaHQ6IDEwMCU7XFxufVxcblwiLCBcIlwiLHtcInZlcnNpb25cIjozLFwic291cmNlc1wiOltcIndlYnBhY2s6Ly8uL3NyYy9zdHlsZS5jc3NcIl0sXCJuYW1lc1wiOltdLFwibWFwcGluZ3NcIjpcIkFBQUE7O0VBRUUsU0FBUztFQUNULFVBQVU7RUFDVixZQUFZO0VBQ1osZ0JBQWdCO0FBQ2xCO0FBQ0E7RUFDRSxXQUFXO0VBQ1gsWUFBWTtBQUNkXCIsXCJzb3VyY2VzQ29udGVudFwiOltcImh0bWwsXFxuYm9keSB7XFxuICBtYXJnaW46IDA7XFxuICBwYWRkaW5nOiAwO1xcbiAgaGVpZ2h0OiAxMDAlO1xcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcXG59XFxuY2FudmFzIHtcXG4gIHdpZHRoOiAxMDAlO1xcbiAgaGVpZ2h0OiAxMDAlO1xcbn1cXG5cIl0sXCJzb3VyY2VSb290XCI6XCJcIn1dKTtcbi8vIEV4cG9ydHNcbmV4cG9ydCBkZWZhdWx0IF9fX0NTU19MT0FERVJfRVhQT1JUX19fO1xuIiwiZXhwb3J0IGRlZmF1bHQgX193ZWJwYWNrX3B1YmxpY19wYXRoX18gKyBcIjA2ZjlkNWNmYjJlZDVhZjNlMTIwMjljNDNhYjdhNzA0LmdsYlwiOyIsIlxuICAgICAgaW1wb3J0IEFQSSBmcm9tIFwiIS4uL25vZGVfbW9kdWxlcy9zdHlsZS1sb2FkZXIvZGlzdC9ydW50aW1lL2luamVjdFN0eWxlc0ludG9TdHlsZVRhZy5qc1wiO1xuICAgICAgaW1wb3J0IGRvbUFQSSBmcm9tIFwiIS4uL25vZGVfbW9kdWxlcy9zdHlsZS1sb2FkZXIvZGlzdC9ydW50aW1lL3N0eWxlRG9tQVBJLmpzXCI7XG4gICAgICBpbXBvcnQgaW5zZXJ0Rm4gZnJvbSBcIiEuLi9ub2RlX21vZHVsZXMvc3R5bGUtbG9hZGVyL2Rpc3QvcnVudGltZS9pbnNlcnRCeVNlbGVjdG9yLmpzXCI7XG4gICAgICBpbXBvcnQgc2V0QXR0cmlidXRlcyBmcm9tIFwiIS4uL25vZGVfbW9kdWxlcy9zdHlsZS1sb2FkZXIvZGlzdC9ydW50aW1lL3NldEF0dHJpYnV0ZXNXaXRob3V0QXR0cmlidXRlcy5qc1wiO1xuICAgICAgaW1wb3J0IGluc2VydFN0eWxlRWxlbWVudCBmcm9tIFwiIS4uL25vZGVfbW9kdWxlcy9zdHlsZS1sb2FkZXIvZGlzdC9ydW50aW1lL2luc2VydFN0eWxlRWxlbWVudC5qc1wiO1xuICAgICAgaW1wb3J0IHN0eWxlVGFnVHJhbnNmb3JtRm4gZnJvbSBcIiEuLi9ub2RlX21vZHVsZXMvc3R5bGUtbG9hZGVyL2Rpc3QvcnVudGltZS9zdHlsZVRhZ1RyYW5zZm9ybS5qc1wiO1xuICAgICAgaW1wb3J0IGNvbnRlbnQsICogYXMgbmFtZWRFeHBvcnQgZnJvbSBcIiEhLi4vbm9kZV9tb2R1bGVzL2Nzcy1sb2FkZXIvZGlzdC9janMuanMhLi9zdHlsZS5jc3NcIjtcbiAgICAgIFxuICAgICAgXG5cbnZhciBvcHRpb25zID0ge307XG5cbm9wdGlvbnMuc3R5bGVUYWdUcmFuc2Zvcm0gPSBzdHlsZVRhZ1RyYW5zZm9ybUZuO1xub3B0aW9ucy5zZXRBdHRyaWJ1dGVzID0gc2V0QXR0cmlidXRlcztcblxuICAgICAgb3B0aW9ucy5pbnNlcnQgPSBpbnNlcnRGbi5iaW5kKG51bGwsIFwiaGVhZFwiKTtcbiAgICBcbm9wdGlvbnMuZG9tQVBJID0gZG9tQVBJO1xub3B0aW9ucy5pbnNlcnRTdHlsZUVsZW1lbnQgPSBpbnNlcnRTdHlsZUVsZW1lbnQ7XG5cbnZhciB1cGRhdGUgPSBBUEkoY29udGVudCwgb3B0aW9ucyk7XG5cblxuXG5leHBvcnQgKiBmcm9tIFwiISEuLi9ub2RlX21vZHVsZXMvY3NzLWxvYWRlci9kaXN0L2Nqcy5qcyEuL3N0eWxlLmNzc1wiO1xuICAgICAgIGV4cG9ydCBkZWZhdWx0IGNvbnRlbnQgJiYgY29udGVudC5sb2NhbHMgPyBjb250ZW50LmxvY2FscyA6IHVuZGVmaW5lZDtcbiIsImV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIERpcmVjdGlvbigpIHtcbiAgbGV0IGxhc3RLZXkgPSBudWxsLFxuICAgIGxhc3RVcFRpbWUgPSAwO1xuICBsZXQgZGlyZWN0aW9uID0ge1xuICAgIGxlZnQ6IGZhbHNlLFxuICAgIGZyb250OiBmYWxzZSxcbiAgICBiYWNrOiBmYWxzZSxcbiAgICByaWdodDogZmFsc2UsXG4gICAgc2hpZnQ6IGZhbHNlLFxuICAgIGRvdWJsZUtleTogJycsXG4gICAgdmFsdWUoKSB7XG4gICAgICBpZiAodGhpcy5sZWZ0ICYmIHRoaXMuZnJvbnQpIHJldHVybiAnTGVmdEZyb250JztcbiAgICAgIGlmICh0aGlzLmxlZnQgJiYgdGhpcy5iYWNrKSByZXR1cm4gJ0xlZnRCYWNrJztcbiAgICAgIGlmICh0aGlzLnJpZ2h0ICYmIHRoaXMuZnJvbnQpIHJldHVybiAnUmlnaHRGcm9udCc7XG4gICAgICBpZiAodGhpcy5yaWdodCAmJiB0aGlzLmJhY2spIHJldHVybiAnUmlnaHRCYWNrJztcbiAgICAgIGlmICh0aGlzLmxlZnQpIHJldHVybiAnTGVmdCc7XG4gICAgICBpZiAodGhpcy5mcm9udCkgcmV0dXJuICdGcm9udCc7XG4gICAgICBpZiAodGhpcy5iYWNrKSByZXR1cm4gJ0JhY2snO1xuICAgICAgaWYgKHRoaXMucmlnaHQpIHJldHVybiAnUmlnaHQnO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0sXG4gIH07XG5cbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uIChldikge1xuICAgIGlmIChsYXN0S2V5ID09PSBldi5jb2RlICYmIG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gbGFzdFVwVGltZSA8IDMwMCkge1xuICAgICAgZGlyZWN0aW9uLmRvdWJsZUtleSA9IGV2LmNvZGU7XG4gICAgfVxuICAgIHN3aXRjaCAoZXYuY29kZSkge1xuICAgICAgY2FzZSAnS2V5QSc6XG4gICAgICAgIGRpcmVjdGlvbi5sZWZ0ID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdLZXlXJzpcbiAgICAgICAgZGlyZWN0aW9uLmZyb250ID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdLZXlEJzpcbiAgICAgICAgZGlyZWN0aW9uLnJpZ2h0ID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdLZXlTJzpcbiAgICAgICAgZGlyZWN0aW9uLmJhY2sgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1NoaWZ0TGVmdCc6XG4gICAgICAgIGRpcmVjdGlvbi5zaGlmdCA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSk7XG5cbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBmdW5jdGlvbiAoZXYpIHtcbiAgICBpZiAoZGlyZWN0aW9uLmRvdWJsZUtleSA9PT0gZXYuY29kZSkgZGlyZWN0aW9uLmRvdWJsZUtleSA9ICcnO1xuICAgIGxhc3RLZXkgPSBldi5jb2RlO1xuICAgIGxhc3RVcFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICBzd2l0Y2ggKGV2LmNvZGUpIHtcbiAgICAgIGNhc2UgJ0tleUEnOlxuICAgICAgICBkaXJlY3Rpb24ubGVmdCA9IGZhbHNlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0tleVcnOlxuICAgICAgICBkaXJlY3Rpb24uZnJvbnQgPSBmYWxzZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdLZXlEJzpcbiAgICAgICAgZGlyZWN0aW9uLnJpZ2h0ID0gZmFsc2U7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnS2V5Uyc6XG4gICAgICAgIGRpcmVjdGlvbi5iYWNrID0gZmFsc2U7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnU2hpZnRMZWZ0JzpcbiAgICAgICAgZGlyZWN0aW9uLnNoaWZ0ID0gZmFsc2U7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pO1xuXG4gIHJldHVybiBkaXJlY3Rpb247XG59XG4iLCJpbXBvcnQgXywgeyBmdW5jdGlvbnNJbiB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgKiBhcyBUSFJFRSBmcm9tICd0aHJlZSc7XG5pbXBvcnQgJy4vc3R5bGUuY3NzJztcbmltcG9ydCB7IE9yYml0Q29udHJvbHMgfSBmcm9tICd0aHJlZS9leGFtcGxlcy9qc20vY29udHJvbHMvT3JiaXRDb250cm9scy5qcyc7XG5pbXBvcnQgeyBQb2ludGVyTG9ja0NvbnRyb2xzIH0gZnJvbSAndGhyZWUvZXhhbXBsZXMvanNtL2NvbnRyb2xzL1BvaW50ZXJMb2NrQ29udHJvbHMuanMnO1xuaW1wb3J0IHsgR1VJIH0gZnJvbSAnZGF0Lmd1aSc7XG5pbXBvcnQgU3RhdHMgZnJvbSAndGhyZWUvZXhhbXBsZXMvanNtL2xpYnMvc3RhdHMubW9kdWxlLmpzJztcbmltcG9ydCBSb2JvdCBmcm9tICcuL1JvYm90RXhwcmVzc2l2ZS5nbGInO1xuaW1wb3J0IHsgR0xURkxvYWRlciB9IGZyb20gJ3RocmVlL2V4YW1wbGVzL2pzbS9sb2FkZXJzL0dMVEZMb2FkZXIuanMnO1xuaW1wb3J0IERpcmVjdGlvbiBmcm9tICcuL2NvbXBvbmVudHMvZGlyZWN0aW9uJztcbmltcG9ydCBjYXNlSW1nIGZyb20gJy4vaW1nL2Nhc2UuanBnJztcbmltcG9ydCBzYW5kSW1nIGZyb20gJy4vaW1nL3NhbmQuanBnJztcblxuZnVuY3Rpb24gbWFpbigpIHtcbiAgY29uc3QgdGV4dHVyZUxvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7IC8v5Zu+54mH5riy5p+T5ZmoXG4gIGNvbnN0IG9ic3RhY2xlID0gW107IC8v6Zqc56KN54mp5YiX6KGoXG4gIGxldCBkaXJlY3Rpb24gPSBEaXJlY3Rpb24oKTsgLy/mlrnlkJFcbiAgbGV0IGNvbnRhaW5lciwgLy9kaXblrrnlmahcbiAgICBjb250cm9scywgLy9kaXblrrnlmahcbiAgICBzdGF0cywgLy9mcHPmjIfnpLrlmahcbiAgICBjbG9jaywgLy/ml7bpkp9cbiAgICBtaXhlciwgLy/liqjnlLvmt7flkIjlmahcbiAgICBhY3Rpb25zLCAvL+ihjOS4ulxuICAgIGFjdGl2ZUFjdGlvbiwgLy/mtLvliqjkuK3ooYzkuLpcbiAgICBwcmV2aW91c0FjdGlvbjsgLy/kuIrkuIDkuKrooYzkuLpcbiAgbGV0IGNhbWVyYSwgLy/nm7jmnLpcbiAgICBzY2VuZSwgLy8g5Zy65pmvXG4gICAgcmVuZGVyZXIsIC8vIOa4suafk+WZqFxuICAgIG1vZGVsLCAvLyDmnLrlmajkurrmqKHlnZdcbiAgICBmYWNlOyAvLyDpnaLpg6jooajmg4VcbiAgbGV0IHRpbWUgPSBudWxsLCAvLyDooYzotbDnirbmgIHpmLLmipZcbiAgICB3YWxrID0gZmFsc2UsIC8vIOaYr+WQpuaYr+ihjOi1sOeKtuaAgVxuICAgIGp1bXAgPSBmYWxzZSwgLy8g5piv5ZCm6Lez6LeD54q25oCBXG4gICAgcmVfanVtcCA9IHRydWUsIC8vIOaYr+WQpui3s+i3g+eKtuaAgVxuICAgIHJlc2V0X2p1bXBfaGVpZ2h0ID0gZmFsc2UsIC8vIOmHjee9rui3s+i3g+mrmOW6plxuICAgIGRlYXRoaW5nID0gZmFsc2UsIC8vIOWNs+Wwhuatu+S6oVxuICAgIGdyb3VuZFBsYW5lID0gMDsgLy8g5Zyw6Z2i6auY5bqmXG5cbiAgY29uc3QgZGlyZWN0aW9uT2JqID0ge1xuICAgIExlZnQ6IC1NYXRoLlBJIC8gMixcbiAgICBMZWZ0QmFjazogLU1hdGguUEkgLyA0LFxuICAgIEJhY2s6IDAsXG4gICAgUmlnaHRCYWNrOiBNYXRoLlBJIC8gNCxcbiAgICBSaWdodDogTWF0aC5QSSAvIDIsXG4gICAgUmlnaHRGcm9udDogKE1hdGguUEkgKiAzKSAvIDQsXG4gICAgRnJvbnQ6IE1hdGguUEksXG4gICAgTGVmdEZyb250OiAtTWF0aC5QSSAvIDIsXG4gIH07XG4gIGNvbnN0IGFwaSA9IHsgc3RhdGU6ICdXYWxraW5nJyB9O1xuICBsZXQgUm9ib3RQb3NpdG9uID0geyB4OiAwLCB5OiAwLCB6OiAwIH07XG5cbiAgbGV0IGZhY2VUbyA9ICdCYWNrJztcblxuICBsZXQgbnVtID0gMDtcbiAgbGV0IG5ld19oZWlnaHQgPSAwO1xuICBsZXQgZmFsbGluZyA9IGZhbHNlO1xuICBsZXQgZmFsbF90aW1lID0gMDtcbiAgbGV0IGZhbGxfaGVpZ2h0ID0gMDtcblxuICBpbml0KCk7XG4gIGFuaW1hdGUoKTtcblxuICBmdW5jdGlvbiBpbml0KCkge1xuICAgIC8v5Yib5bu6ZGl2XG4gICAgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjb250YWluZXIpO1xuXG4gICAgLy/liJvlu7rnm7jmnLpcbiAgICBjYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoXG4gICAgICA0NSxcbiAgICAgIHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0LFxuICAgICAgMC4yNSxcbiAgICAgIDEwMDBcbiAgICApO1xuICAgIGNhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMTAwLCAxNTApO1xuICAgIGNhbWVyYS5sb29rQXQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCkpO1xuXG4gICAgLy/liJvlu7rlnLrmma9cbiAgICBzY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xuICAgIHNjZW5lLmJhY2tncm91bmQgPSBuZXcgVEhSRUUuQ29sb3IoMHhlMGUwZTApO1xuICAgIC8v5Yib5bu66Zu+XG4gICAgc2NlbmUuZm9nID0gbmV3IFRIUkVFLkZvZygweGUwZTBlMCwgMjAsIDUwMCk7XG4gICAgLy/ml7bpl7RcbiAgICBjbG9jayA9IG5ldyBUSFJFRS5DbG9jaygpO1xuXG4gICAgLy/lpKnnqbrlnLDpnaLlhYlcbiAgICBjb25zdCBoZW1pTGlnaHQgPSBuZXcgVEhSRUUuSGVtaXNwaGVyZUxpZ2h0KDB4ZmZmZmZmLCAweDQ0NDQ0NCk7XG4gICAgaGVtaUxpZ2h0LnBvc2l0aW9uLnNldCgwLCAyMCwgMCk7XG4gICAgc2NlbmUuYWRkKGhlbWlMaWdodCk7XG5cbiAgICAvL+aWueWQkeWFiVxuICAgIGNvbnN0IGRpckxpZ2h0ID0gbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYpO1xuICAgIGRpckxpZ2h0LnBvc2l0aW9uLnNldCgwLCAyMCwgMTApO1xuICAgIHNjZW5lLmFkZChkaXJMaWdodCk7XG5cbiAgICAvLyBncm91bmRcblxuICAgIGNvbnN0IG1lc2ggPSBuZXcgVEhSRUUuTWVzaChcbiAgICAgIG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDIwMDAsIDIwMDApLFxuICAgICAgLy9kZXB0aFdyaXRlIOaYr+WQpua4suafk+eci+S4jeWIsOeahOWcsOaWuVxuICAgICAgbmV3IFRIUkVFLk1lc2hQaG9uZ01hdGVyaWFsKHsgY29sb3I6IDB4OTk5OTk5LCBkZXB0aFdyaXRlOiBmYWxzZSB9KVxuICAgICk7XG4gICAgbWVzaC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyO1xuICAgIHNjZW5lLmFkZChtZXNoKTtcblxuICAgIC8v5Zyw6Z2i6L6F5Yqp57q/XG4gICAgY29uc3QgZ3JpZCA9IG5ldyBUSFJFRS5HcmlkSGVscGVyKDEwMDAsIDIwMCwgMHgwMDAwMDAsIDB4MDAwMDAwKTtcbiAgICBncmlkLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjI7XG4gICAgZ3JpZC5tYXRlcmlhbC50cmFuc3BhcmVudCA9IHRydWU7XG4gICAgc2NlbmUuYWRkKGdyaWQpO1xuXG4gICAgY29uc3QgYm94X21hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hMYW1iZXJ0TWF0ZXJpYWwoe1xuICAgICAgbWFwOiB0ZXh0dXJlTG9hZGVyLmxvYWQoY2FzZUltZyksXG4gICAgfSk7XG5cbiAgICBjb25zdCBibHVlX21hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hMYW1iZXJ0TWF0ZXJpYWwoeyBjb2xvcjogMHgxODkwZmYgfSk7XG4gICAgY29uc3QgZ3JleV9tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoTGFtYmVydE1hdGVyaWFsKHsgY29sb3I6IDB4ZDlkOWQ5IH0pO1xuXG4gICAgLy/ms7PmsaBcbiAgICBuZXdCb3goNCwgNCwgNCwgYm94X21hdGVyaWFsLCAtNywgMiwgLTE1KTtcbiAgICBuZXdCb3goMTAsIDEwLCAxMCwgYm94X21hdGVyaWFsLCAtMTMsIDUsIC0xNSk7XG4gICAgbmV3Qm94KDMwLCAxLCA4LCBib3hfbWF0ZXJpYWwsIC0zMCwgOCwgLTE1KTtcbiAgICBuZXdCb3goMTAwLCAxLCAxMDAsIGJsdWVfbWF0ZXJpYWwsIC02MCwgMC41LCAtMTUpO1xuICAgIG5ld0JveCgxMDIsIDEsIDEwMiwgZ3JleV9tYXRlcmlhbCwgLTYwLCAwLjQsIC0xNSk7XG5cbiAgICAvLyDmnKjnrrHpmLVcbiAgICBuZXdCb3goNCwgNCwgNCwgYm94X21hdGVyaWFsLCA3LCAyLCAtMTUpOyAvLyAxXG4gICAgbmV3Qm94KDEwLCAxMCwgMTAsIGJveF9tYXRlcmlhbCwgMTUsIDUsIC0xNSk7IC8vIDJcbiAgICBuZXdCb3goMTAsIDEwLCAxMCwgYm94X21hdGVyaWFsLCAzMCwgNSwgLTE1KTsgLy8gM1xuICAgIG5ld0JveCgxMCwgMTAsIDEwLCBib3hfbWF0ZXJpYWwsIDMwLCA1LCAtMzApOyAvLyA0XG4gICAgbmV3Qm94KDEwLCAxMCwgMTAsIGJveF9tYXRlcmlhbCwgMzAsIDUsIC00NSk7IC8vIDVcbiAgICBuZXdCb3goMTAsIDEwLCAxMCwgYm94X21hdGVyaWFsLCA0OCwgNSwgLTQ1KTsgLy8gNlxuICAgIG5ld0JveCgxMCwgMTAsIDEwLCBib3hfbWF0ZXJpYWwsIDY2LCA1LCAtNDUpOyAvLyA3XG4gICAgbmV3Qm94KDEwLCAxMCwgMTAsIGJveF9tYXRlcmlhbCwgNjYsIDUsIC0yNSk7IC8vIDhcbiAgICBuZXdCb3goMTAsIDEwLCAxMCwgYm94X21hdGVyaWFsLCA2NiwgNSwgLTUpOyAvLyA5XG4gICAgbmV3Qm94KDEwLCAxMCwgMTAsIGJveF9tYXRlcmlhbCwgNDYsIDUsIDE1KTsgLy8gMTBcblxuICAgIGZ1bmN0aW9uIG5ld0JveCh3aWR0aCwgaGVpZ2h0LCBsZW5ndGgsIG1hdGVyaWFsLCB4LCB5LCB6KSB7XG4gICAgICBjb25zdCBib3ggPSBuZXcgVEhSRUUuTWVzaChcbiAgICAgICAgbmV3IFRIUkVFLkJveEdlb21ldHJ5KHdpZHRoLCBoZWlnaHQsIGxlbmd0aCksXG4gICAgICAgIG1hdGVyaWFsXG4gICAgICApO1xuICAgICAgYm94LnBvc2l0aW9uLnNldCh4LCB5LCB6KTtcbiAgICAgIHNjZW5lLmFkZChib3gpO1xuICAgICAgb2JzdGFjbGUucHVzaChib3gpO1xuICAgIH1cblxuICAgIC8v5re75Yqg5LiA5Liq6ZSl5L2TXG4gICAgLy8gY29uc3QgY29uZSA9IG5ldyBUSFJFRS5NZXNoKFxuICAgIC8vICAgbmV3IFRIUkVFLkNvbmVHZW9tZXRyeSg4LCAxNSwgNTApLFxuICAgIC8vICAgbmV3IFRIUkVFLk1lc2hMYW1iZXJ0TWF0ZXJpYWwoeyBtYXA6IHRleHR1cmVMb2FkZXIubG9hZChzYW5kSW1nKSB9KVxuICAgIC8vICk7XG4gICAgLy8gY29uZS5yb3RhdGlvbi5zZXQoMCwgTWF0aC5QSSAvIDIsIDApO1xuICAgIC8vIGNvbmUucG9zaXRpb24uc2V0KDE1LCA3LCAwKTtcbiAgICAvLyBzY2VuZS5hZGQoY29uZSk7XG4gICAgLy8gb2JzdGFjbGUucHVzaChjb25lKTtcblxuICAgIC8vIG1vZGVsXG5cbiAgICBjb25zdCBsb2FkZXIgPSBuZXcgR0xURkxvYWRlcigpO1xuXG4gICAgbG9hZGVyLmxvYWQoXG4gICAgICBSb2JvdCxcbiAgICAgIGZ1bmN0aW9uIChnbHRmKSB7XG4gICAgICAgIG1vZGVsID0gZ2x0Zi5zY2VuZTtcbiAgICAgICAgc2NlbmUuYWRkKG1vZGVsKTtcbiAgICAgICAgY29uc29sZS5sb2cobW9kZWwpO1xuXG4gICAgICAgIGFjdGlvbkluaXQobW9kZWwsIGdsdGYuYW5pbWF0aW9ucyk7XG4gICAgICB9LFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7IGFudGlhbGlhczogdHJ1ZSB9KTtcbiAgICByZW5kZXJlci5zZXRQaXhlbFJhdGlvKHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvKTtcbiAgICByZW5kZXJlci5zZXRTaXplKHdpbmRvdy5pbm5lcldpZHRoLCB3aW5kb3cuaW5uZXJIZWlnaHQpO1xuICAgIHJlbmRlcmVyLm91dHB1dEVuY29kaW5nID0gVEhSRUUuc1JHQkVuY29kaW5nO1xuICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChyZW5kZXJlci5kb21FbGVtZW50KTtcblxuICAgIC8v5o6n5Yi25ZmoXG4gICAgY29udHJvbHMgPSBuZXcgT3JiaXRDb250cm9scyhjYW1lcmEsIHJlbmRlcmVyLmRvbUVsZW1lbnQpO1xuXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uV2luZG93UmVzaXplKTtcbiAgICBzdGF0cyA9IG5ldyBTdGF0cygpO1xuICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChzdGF0cy5kb20pO1xuICB9XG5cbiAgZnVuY3Rpb24gYWN0aW9uSW5pdChtb2RlbCwgYW5pbWF0aW9ucykge1xuICAgIGNvbnN0IHN0YXRlcyA9IFtcbiAgICAgICdJZGxlJyxcbiAgICAgICdXYWxraW5nJyxcbiAgICAgICdSdW5uaW5nJyxcbiAgICAgICdEYW5jZScsXG4gICAgICAnRGVhdGgnLFxuICAgICAgJ1NpdHRpbmcnLFxuICAgICAgJ1N0YW5kaW5nJyxcbiAgICBdO1xuICAgIGNvbnN0IGVtb3RlcyA9IFtcbiAgICAgICdKdW1wJyxcbiAgICAgICdZZXMnLFxuICAgICAgJ05vJyxcbiAgICAgICdXYXZlJyxcbiAgICAgICdQdW5jaCcsXG4gICAgICAnVGh1bWJzVXAnLFxuICAgICAgJ1dhbGtKdW1wJyxcbiAgICBdO1xuXG4gICAgLy/ms6jlhozliqjnlLvooYzkuLpcbiAgICBtaXhlciA9IG5ldyBUSFJFRS5BbmltYXRpb25NaXhlcihtb2RlbCk7XG5cbiAgICBhY3Rpb25zID0ge307XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbmltYXRpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBjbGlwID0gYW5pbWF0aW9uc1tpXTtcbiAgICAgIGNvbnN0IGFjdGlvbiA9IG1peGVyLmNsaXBBY3Rpb24oY2xpcCk7XG4gICAgICBhY3Rpb25zW2NsaXAubmFtZV0gPSBhY3Rpb247XG5cbiAgICAgIGlmIChlbW90ZXMuaW5kZXhPZihjbGlwLm5hbWUpID49IDAgfHwgc3RhdGVzLmluZGV4T2YoY2xpcC5uYW1lKSA+PSA0KSB7XG4gICAgICAgIGFjdGlvbi5jbGFtcFdoZW5GaW5pc2hlZCA9IHRydWU7XG4gICAgICAgIGFjdGlvbi5sb29wID0gVEhSRUUuTG9vcE9uY2U7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gb25XaW5kb3dSZXNpemUoKSB7XG4gICAgY2FtZXJhLmFzcGVjdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0O1xuICAgIGNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XG5cbiAgICByZW5kZXJlci5zZXRTaXplKHdpbmRvdy5pbm5lcldpZHRoLCB3aW5kb3cuaW5uZXJIZWlnaHQpO1xuICB9XG5cbiAgZnVuY3Rpb24gY2hhbmdlRGlyZWN0aW9uKGNvZGUpIHtcbiAgICBtb2RlbC5yb3RhdGlvbi55ID0gZGlyZWN0aW9uT2JqW2NvZGVdO1xuICB9XG5cbiAgZnVuY3Rpb24gZmFkZVRvQWN0aW9uKG5hbWUsIGR1cmF0aW9uKSB7XG4gICAgcHJldmlvdXNBY3Rpb24gPSBhY3RpdmVBY3Rpb247XG4gICAgYWN0aXZlQWN0aW9uID0gYWN0aW9uc1tuYW1lXTtcbiAgICBpZiAocHJldmlvdXNBY3Rpb24gJiYgcHJldmlvdXNBY3Rpb24gIT09IGFjdGl2ZUFjdGlvbikge1xuICAgICAgcHJldmlvdXNBY3Rpb24uZmFkZU91dChkdXJhdGlvbik7XG4gICAgfVxuXG4gICAgYWN0aXZlQWN0aW9uXG4gICAgICAucmVzZXQoKVxuICAgICAgLnNldEVmZmVjdGl2ZVRpbWVTY2FsZSgxKVxuICAgICAgLnNldEVmZmVjdGl2ZVdlaWdodCgxKVxuICAgICAgLmZhZGVJbihkdXJhdGlvbilcbiAgICAgIC5wbGF5KCk7XG4gIH1cbiAgbGV0IGtleUFjdGlvbiA9IHtcbiAgICBEaWdpdDE6ICdEYW5jZScsXG4gICAgRGlnaXQyOiAnTm8nLFxuICAgIERpZ2l0MzogJ1B1bmNoJyxcbiAgICBEaWdpdDQ6ICdTaXR0aW5nJyxcbiAgICBEaWdpdDU6ICdTdGFuZGluZycsXG4gICAgRGlnaXQ2OiAnVGh1bWJzVXAnLFxuICAgIERpZ2l0NzogJ1dhbGtKdW1wJyxcbiAgICBEaWdpdDg6ICdXYXZlJyxcbiAgICBEaWdpdDk6ICdZZXMnLFxuICB9O1xuICBsZXQgc2hpZnRfZG93biA9IGZhbHNlO1xuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24gKGUpIHtcbiAgICBpZiAoZS5jb2RlID09PSAnU3BhY2UnICYmIHJlX2p1bXApIHtcbiAgICAgIGFjdGlvbih3YWxrICYmIHNoaWZ0X2Rvd24gPyAnV2Fsa0p1bXAnIDogJ0p1bXAnKTtcbiAgICAgIGlmIChqdW1wID09PSB0cnVlKSByZXNldF9qdW1wX2hlaWdodCA9IHRydWU7XG4gICAgICBqdW1wID0gdHJ1ZTtcbiAgICAgIG5ld19oZWlnaHQgPSBSb2JvdFBvc2l0b24ueTtcbiAgICAgIHJlX2p1bXAgPSBmYWxzZTtcbiAgICB9XG4gICAgaWYgKGtleUFjdGlvbltlLmNvZGVdKSB7XG4gICAgICBhY3Rpb24oa2V5QWN0aW9uW2UuY29kZV0pO1xuICAgIH1cbiAgfSk7XG4gIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgZnVuY3Rpb24gKGUpIHtcbiAgICBpZiAoZS5jb2RlID09PSAnU3BhY2UnKSB7XG4gICAgICAvLyByZV9qdW1wID0gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuICBmdW5jdGlvbiBpc1dhbGsoZGlyZWN0aW9uKSB7XG4gICAgY29uc3Qgd2Fsa2luZyA9IGRpcmVjdGlvbi52YWx1ZSgpO1xuICAgIGlmICghd2Fsa2luZykgcmV0dXJuIGZhbHNlO1xuICAgIHRpbWUgJiYgY2xlYXJUaW1lb3V0KHRpbWUpO1xuICAgIGlmICghd2FsayB8fCBzaGlmdF9kb3duICE9PSBkaXJlY3Rpb24uc2hpZnQpIHtcbiAgICAgIHNoaWZ0X2Rvd24gPSBkaXJlY3Rpb24uc2hpZnQ7XG4gICAgICBmYWRlVG9BY3Rpb24oc2hpZnRfZG93biA/ICdSdW5uaW5nJyA6ICdXYWxraW5nJywgMC4yKTtcbiAgICB9XG4gICAgdGltZSA9IHNldFRpbWVvdXQoXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHdhbGsgPSBmYWxzZTtcbiAgICAgICAgZmFkZVRvQWN0aW9uKCdJZGxlJywgMC4yKTtcbiAgICAgIH0sXG4gICAgICB3YWxrID8gMTAwIDogNjAwXG4gICAgKTtcbiAgICB3YWxrID0gdHJ1ZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGFjdGlvbihuYW1lLCB0aW1lID0gMC4yKSB7XG4gICAgZmFkZVRvQWN0aW9uKG5hbWUsIHRpbWUpO1xuICAgIC8vIOaJp+ihjOe7k+adn+aBouWkjeeKtuaAgVxuICAgIG1peGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2ZpbmlzaGVkJywgcmVzdG9yZVN0YXRlKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZSgpIHtcbiAgICBtaXhlci5yZW1vdmVFdmVudExpc3RlbmVyKCdmaW5pc2hlZCcsIHJlc3RvcmVTdGF0ZSk7XG5cbiAgICBmYWRlVG9BY3Rpb24od2FsayA/IChzaGlmdF9kb3duID8gJ1J1bm5pbmcnIDogJ1dhbGtpbmcnKSA6ICdJZGxlJywgMC4yKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldERpcmVjdGlvbihkaXJlKSB7XG4gICAgaWYgKCFkaXJlKSByZXR1cm47XG4gICAgaWYgKGZhY2VUbyAhPT0gZGlyZSkge1xuICAgICAgY2hhbmdlRGlyZWN0aW9uKGRpcmUpO1xuICAgIH1cbiAgICBmYWNlVG8gPSBkaXJlO1xuICB9XG4gIGZ1bmN0aW9uIGdldFBvc2l0aW9uKGRpcmUpIHtcbiAgICBsZXQgbGVuZ3RoID0gZGlyZS5zaGlmdCA/IDAuMiA6IDAuMTtcbiAgICBsZXQgeCA9IFJvYm90UG9zaXRvbi54LFxuICAgICAgaGVpZ2h0ID0gUm9ib3RQb3NpdG9uLnksXG4gICAgICB6ID0gUm9ib3RQb3NpdG9uLno7XG4gICAgaWYgKGRpcmVjdGlvbi5sZWZ0KSB4IC09IGxlbmd0aDtcbiAgICBpZiAoZGlyZWN0aW9uLmZyb250KSB6IC09IGxlbmd0aDtcbiAgICBpZiAoZGlyZWN0aW9uLmJhY2spIHogKz0gbGVuZ3RoO1xuICAgIGlmIChkaXJlY3Rpb24ucmlnaHQpIHggKz0gbGVuZ3RoO1xuICAgIGlmIChqdW1wKSB7XG4gICAgICBudW0gKz0gMC4xO1xuICAgICAgaWYgKHJlc2V0X2p1bXBfaGVpZ2h0KSB7XG4gICAgICAgIG5ld19oZWlnaHQgPSBSb2JvdFBvc2l0b24ueTtcbiAgICAgICAgcmVzZXRfanVtcF9oZWlnaHQgPSBmYWxzZTtcbiAgICAgICAgbnVtID0gMDtcbiAgICAgICAgaWYgKG5ld19oZWlnaHQgPiA1MCkge1xuICAgICAgICAgIGRlYXRoaW5nID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbGV0IHkgPSAobmV3X2hlaWdodCArIDggLSAyICogTWF0aC5wb3cobnVtIC0gMiwgMikpLnRvRml4ZWQoMik7XG4gICAgICBpZiAoeSA+IDApIHtcbiAgICAgICAgaGVpZ2h0ID0gTnVtYmVyKHkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGVpZ2h0ID0gMDtcbiAgICAgICAganVtcCA9IGZhbHNlO1xuICAgICAgICBudW0gPSAwO1xuICAgICAgICBuZXdfaGVpZ2h0ID0gMDtcbiAgICAgICAgaWYgKGRlYXRoaW5nKSB7XG4gICAgICAgICAgZGVhdGhpbmcgPSBmYWxzZTtcbiAgICAgICAgICBmYWRlVG9BY3Rpb24oJ0RlYXRoJywgMC4yKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChub0NvbGxpc2lvbkNoZWNrKG9ic3RhY2xlLCB4LCBoZWlnaHQsIHopKSByZXR1cm47XG5cbiAgICBpZiAoaGVpZ2h0ID4gMCAmJiAhanVtcCkge1xuICAgICAgaWYgKCFub0NvbGxpc2lvbkNoZWNrKG9ic3RhY2xlLCB4LCBoZWlnaHQgLSAxLCB6KSkge1xuICAgICAgICBpZiAoIWZhbGxpbmcpIHtcbiAgICAgICAgICBmYWxsaW5nID0gdHJ1ZTtcbiAgICAgICAgICBmYWxsX3RpbWUgPSAwO1xuICAgICAgICAgIGZhbGxfaGVpZ2h0ID0gUm9ib3RQb3NpdG9uLnk7XG4gICAgICAgIH1cbiAgICAgICAgZmFsbF90aW1lICs9IDAuMTtcbiAgICAgICAgbGV0IGVuZF9oZWlnaHQgPSBmYWxsX2hlaWdodCAtIE1hdGgucG93KGZhbGxfdGltZSwgMik7XG4gICAgICAgIGlmIChlbmRfaGVpZ2h0ID4gMCkge1xuICAgICAgICAgIGhlaWdodCA9IGVuZF9oZWlnaHQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaGVpZ2h0ID0gMDtcbiAgICAgICAgICBmYWxsaW5nID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlX2p1bXAgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChoZWlnaHQgPT09IDApIHtcbiAgICAgIHJlX2p1bXAgPSB0cnVlO1xuICAgIH1cblxuICAgIFJvYm90UG9zaXRvbi54ID0geDtcbiAgICBSb2JvdFBvc2l0b24ueSA9IGhlaWdodDtcbiAgICBSb2JvdFBvc2l0b24ueiA9IHo7XG4gIH1cblxuICBmdW5jdGlvbiBub0NvbGxpc2lvbkNoZWNrKG9ic3RhY2xlLCB4LCBoZWlnaHQsIHopIHtcbiAgICByZXR1cm4gb2JzdGFjbGUuc29tZSgoYSkgPT4ge1xuICAgICAgaWYgKGEuZ2VvbWV0cnkudHlwZSA9PT0gJ0JveEdlb21ldHJ5Jykge1xuICAgICAgICAvLyDnrrHlrZBcbiAgICAgICAgbGV0IGdlbyA9IGEuZ2VvbWV0cnk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgeCAtIDIgPCBhLnBvc2l0aW9uLnggKyBnZW8ucGFyYW1ldGVycy53aWR0aCAvIDIgJiZcbiAgICAgICAgICB4ICsgMiA+IGEucG9zaXRpb24ueCAtIGdlby5wYXJhbWV0ZXJzLndpZHRoIC8gMiAmJlxuICAgICAgICAgIGhlaWdodCA8IGEucG9zaXRpb24ueSArIGdlby5wYXJhbWV0ZXJzLmhlaWdodCAvIDIgJiZcbiAgICAgICAgICBoZWlnaHQgKyAyID4gYS5wb3NpdGlvbi55IC0gZ2VvLnBhcmFtZXRlcnMuaGVpZ2h0IC8gMiAmJlxuICAgICAgICAgIHogLSAyIDwgYS5wb3NpdGlvbi56ICsgZ2VvLnBhcmFtZXRlcnMuZGVwdGggLyAyICYmXG4gICAgICAgICAgeiArIDIgPiBhLnBvc2l0aW9uLnogLSBnZW8ucGFyYW1ldGVycy5kZXB0aCAvIDJcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhLmdlb21ldHJ5LnR5cGUgPT09ICdDb25lR2VvbWV0cnknKSB7XG4gICAgICAgIC8vIOmUpeW9olxuICAgICAgICBsZXQgZ2VvID0gYS5nZW9tZXRyeTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICB4IC0gMiA8IGEucG9zaXRpb24ueCArIGdlby5wYXJhbWV0ZXJzLnJhZGl1cyAmJlxuICAgICAgICAgIHggKyAyID4gYS5wb3NpdGlvbi54IC0gZ2VvLnBhcmFtZXRlcnMucmFkaXVzICYmXG4gICAgICAgICAgaGVpZ2h0IDwgYS5wb3NpdGlvbi55ICsgZ2VvLnBhcmFtZXRlcnMuaGVpZ2h0IC8gMiAmJlxuICAgICAgICAgIGhlaWdodCArIDIgPiBhLnBvc2l0aW9uLnkgLSBnZW8ucGFyYW1ldGVycy5oZWlnaHQgLyAyICYmXG4gICAgICAgICAgeiAtIDIgPCBhLnBvc2l0aW9uLnogKyBnZW8ucGFyYW1ldGVycy5yYWRpdXMgJiZcbiAgICAgICAgICB6ICsgMiA+IGEucG9zaXRpb24ueiAtIGdlby5wYXJhbWV0ZXJzLnJhZGl1c1xuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gYW5pbWF0ZSgpIHtcbiAgICBsZXQgZGlyZSA9IGRpcmVjdGlvbi52YWx1ZSgpO1xuICAgIGdldERpcmVjdGlvbihkaXJlKTtcbiAgICBpc1dhbGsoZGlyZWN0aW9uKTtcbiAgICBnZXRQb3NpdGlvbihkaXJlY3Rpb24pO1xuICAgIG1vZGVsICYmIG1vZGVsLnBvc2l0aW9uLnNldChSb2JvdFBvc2l0b24ueCwgUm9ib3RQb3NpdG9uLnksIFJvYm90UG9zaXRvbi56KTtcbiAgICBjb25zdCBkdCA9IGNsb2NrLmdldERlbHRhKCk7XG5cbiAgICBpZiAobWl4ZXIpIG1peGVyLnVwZGF0ZShkdCk7XG5cbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7XG5cbiAgICByZW5kZXJlci5yZW5kZXIoc2NlbmUsIGNhbWVyYSk7XG4gICAgY29udHJvbHMudXBkYXRlKCk7XG4gICAgc3RhdHMudXBkYXRlKCk7XG4gIH1cbn1cblxubWFpbigpO1xuIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9